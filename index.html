<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Skyblock Auction Sniper</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: #e0e0e0;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #bb86fc;
    }
    #status {
      text-align: center;
      font-size: 1.2em;
      margin: 20px 0;
      color: #03dac6;
    }
    #deals {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .deal {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    }
    .deal img {
      width: 64px;
      height: 64px;
      image-rendering: pixelated;
      margin-right: 15px;
      vertical-align: middle;
    }
    .deal-info {
      display: inline-block;
      vertical-align: middle;
      width: calc(100% - 80px);
    }
    .deal-name {
      font-weight: bold;
      font-size: 1.1em;
      color: #ffffff;
    }
    .deal-price {
      font-size: 1.3em;
      color: #cfcfcf;
      margin: 8px 0;
    }
    .deal-discount {
      font-size: 1em;
      margin: 5px 0;
    }
    .next-bin {
      color: #ffeb3b;
    }
    .avg-disc {
      color: #4caf50;
    }
    .deal-cmd {
      background: #2d2d2d;
      padding: 8px;
      border-radius: 4px;
      font-family: monospace;
      word-break: break-all;
      margin-top: 10px;
      cursor: pointer;
      user-select: all;
    }
    .deal.removing {
      opacity: 0;
      transform: translateY(20px);
    }
  </style>
</head>
<body>
  <h1>Skyblock Auction Sniper</h1>
  <div id="status">Loading...</div>
  <div id="deals"></div>

  <script>
    // CHANGE THIS TO YOUR BACKEND URL
    const backendUrl = 'http://localhost:8080';  // e.g., 'https://your-project.appspot.com'

    function removeDealGracefully(dealId) {
      const element = document.getElementById('deal-' + dealId);
      if (element) {
        element.classList.add('removing');
        setTimeout(() => element.remove(), 500);
      }
    }

    async function fetchDeals() {
      try {
        const resp = await fetch(`${backendUrl}/data`);
        const data = await resp.json();
        document.getElementById('status').textContent = data.status || 'No status';

        const dealsContainer = document.getElementById('deals');
        const currentIds = new Set(data.deals.map(d => d.id));

        // Add new deals (prepend so newest on top)
        data.deals.forEach(deal => {
          if (document.getElementById('deal-' + deal.id)) return;  // Already exists

          const div = document.createElement('div');
          div.className = 'deal';
          div.id = 'deal-' + deal.id;
          div.dataset.id = deal.id;

          const nextBinText = deal.disc_vs_next_bin !== null 
            ? `<span class="deal-discount next-bin">Undercut next BIN by ${deal.disc_vs_next_bin}%</span><br>` 
            : '';

          const avgText = deal.disc_vs_avg !== null 
            ? `<span class="deal-discount avg-disc">Under 7-day avg by ${deal.disc_vs_avg}%</span>` 
            : '';

          div.innerHTML = `
            <img src="${deal.image}" alt="${deal.name}">
            <div class="deal-info">
              <div class="deal-name">${deal.name}</div>
              <div class="deal-price">${deal.price.toLocaleString()} coins</div>
              ${nextBinText}
              ${avgText}
              <div class="deal-cmd" onclick="navigator.clipboard.writeText('${deal.cmd}')">Click to copy: ${deal.cmd}</div>
            </div>
          `;

          dealsContainer.prepend(div);

          // Auto-remove after 2 minutes (freshness threshold)
          setTimeout(() => removeDealGracefully(deal.id), 120000);
        });

        // Remove deals no longer in the current data
        Array.from(dealsContainer.children).forEach(el => {
          if (!currentIds.has(el.dataset.id)) {
            removeDealGracefully(el.dataset.id);
          }
        });

      } catch (e) {
        console.error(e);
        document.getElementById('status').textContent = 'Error connecting to backend';
      }
    }

    // Poll every 5 seconds
    setInterval(fetchDeals, 5000);
    fetchDeals();  // Initial fetch
  </script>
</body>
</html>
